[supervisord]
nodaemon=true
logfile=/dev/stdout
logfile_maxbytes=0
loglevel=info
pidfile=/tmp/supervisord.pid
user=user

# =============================================================================
# Xvfb - Virtual X Server with RANDR for dynamic resolution
# Max screen 3840x2160 allows resizing up to 4K, initial res set by VNC_RESOLUTION
# =============================================================================
[program:xvfb]
command=/usr/bin/Xvfb %(ENV_DISPLAY)s -screen 0 3840x2160x%(ENV_VNC_COL_DEPTH)s -ac +extension GLX +extension RANDR +render -noreset
autorestart=true
priority=100
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# x11vnc - VNC Server
# =============================================================================
[program:x11vnc]
command=/usr/bin/x11vnc -display %(ENV_DISPLAY)s -rfbport %(ENV_VNC_PORT)s -passwd %(ENV_VNC_PW)s -shared -forever -xrandr -noxdamage -noxfixes -noxrecord -wait 5 -defer 5
autorestart=true
priority=200
startsecs=3
startretries=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# Openbox - Minimal Window Manager + autostart
# =============================================================================
[program:openbox]
command=sh -c "sleep 2 && /home/user/.config/openbox/autostart & exec /usr/bin/openbox --config-file /home/user/.config/openbox/rc.xml"
environment=DISPLAY="%(ENV_DISPLAY)s",HOME="/home/user",BROWSER="%(ENV_BROWSER)s",STARTING_URL="%(ENV_STARTING_URL)s"
autorestart=true
priority=300
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# noVNC - Web VNC Client
# =============================================================================
[program:novnc]
command=/opt/noVNC/utils/novnc_proxy --vnc localhost:%(ENV_VNC_PORT)s --listen %(ENV_NOVNC_PORT)s --web /opt/noVNC
directory=/opt/noVNC
autorestart=true
priority=400
startsecs=5
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# Resize Server - HTTP API for dynamic resolution
# =============================================================================
[program:resize-server]
command=/usr/bin/python3 /usr/local/bin/resize-server.py
environment=DISPLAY=":0"
autorestart=true
priority=500
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0