[supervisord]
nodaemon=true
logfile=/dev/stdout
logfile_maxbytes=0
loglevel=info
pidfile=/tmp/supervisord.pid
user=user

# =============================================================================
# Xvnc (TigerVNC) - Combined X Server + VNC Server with native SetDesktopSize
# =============================================================================
[program:xvnc]
command=/usr/bin/Xvnc %(ENV_DISPLAY)s -geometry %(ENV_VNC_RESOLUTION)s -depth %(ENV_VNC_COL_DEPTH)s -rfbport %(ENV_VNC_PORT)s -PasswordFile /home/user/.vnc/passwd -AcceptSetDesktopSize -AlwaysShared -SecurityTypes VncAuth
autorestart=true
priority=100
startsecs=3
startretries=5
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# IceWM - Lightweight Window Manager (with built-in taskbar)
# =============================================================================
[program:icewm]
command=sh -c "sleep 2 && /home/user/.icewm/startup && exec /usr/bin/icewm"
environment=DISPLAY="%(ENV_DISPLAY)s",HOME="/home/user",STARTING_URL="%(ENV_STARTING_URL)s"
autorestart=true
priority=300
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# noVNC - Web VNC Client
# =============================================================================
[program:novnc]
command=/opt/noVNC/utils/novnc_proxy --vnc localhost:%(ENV_VNC_PORT)s --listen %(ENV_NOVNC_PORT)s --web /opt/noVNC
directory=/opt/noVNC
autorestart=true
priority=400
startsecs=5
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# VNC Resize Initializer - Triggers ExtDesktopSize for Guacamole compatibility
# =============================================================================
[program:vnc-resize-init]
command=/bin/sh /usr/local/bin/vnc-resize-init.sh
environment=DISPLAY="%(ENV_DISPLAY)s"
autorestart=true
priority=450
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0

# =============================================================================
# Resize Server - HTTP API for dynamic resolution
# =============================================================================
[program:resize-server]
command=/usr/bin/python3 /usr/local/bin/resize-server.py
environment=DISPLAY=":0"
autorestart=true
priority=500
startsecs=2
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0